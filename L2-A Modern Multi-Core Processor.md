> Forms of parallelism: multi-core, SIMD, and multi-threading

# 1 review
## 1.1 computer programç¨‹åº
![[Pasted image 20251005150140.png|425]]
**â“What is a computer program?**
==A program is a list of processor instructions==
**â“What is an instruction?**
==An instruction is a list of commands, the commands modify the state in machine==
***ç¨‹åºæ˜¯ä¸€ç³»åˆ—å¤„ç†å™¨æŒ‡ä»¤ï¼Œä¸€æ¡æŒ‡ä»¤æ˜¯ä¸€ä¸²å‘½ä»¤çš„åˆ—è¡¨ï¼Œè¿™äº›å‘½ä»¤ä¿®æ”¹æœºå™¨ä¸­çš„çŠ¶æ€***
![[Pasted image 20251005100659.png]]
program text ->(compile code)-> a list of commands
ç¨‹åºæ–‡æœ¬ ->ï¼ˆç¼–è¯‘ä»£ç ï¼‰-> ä¸€ä¸²å‘½ä»¤

## 1.2 processorå¤„ç†å™¨
![[Pasted image 20251005150237.png|550]]
**â“What does a processor do?**
==A processor executes instructions==
***å¤„ç†å™¨æ‰§è¡ŒæŒ‡ä»¤***


![[Pasted image 20251005101637.png|A processor executes instructions å¤„ç†å™¨æ‰§è¡ŒæŒ‡ä»¤]]
* **å–æŒ‡ã€è¯‘ç **ï¼šå†³å®šä¸‹ä¸€æ¬¡è¿è¡Œå“ªä¸€ä¸ªæŒ‡ä»¤
* **ALUï¼ˆArithmetic Logic Unit ç®—æœ¯é€»è¾‘å•å…ƒï¼‰ï¼ˆæ‰§è¡Œå•å…ƒï¼‰**ï¼šæ‰§è¡ŒæŒ‡ä»¤çš„æ“ä½œï¼Œå¯èƒ½ä¼šä¿®æ”¹å¤„ç†å™¨çš„å¯„å­˜å™¨æˆ–è€…ç”µè„‘çš„å†…å­˜å€¼
* **å¯„å­˜å™¨**ï¼šç»´æŠ¤ç¨‹åºçŠ¶æ€ï¼Œå­˜å‚¨è¾“å…¥è¾“å‡ºç»™æ“ä½œçš„å˜é‡å€¼



![[Pasted image 20251005145212.png]]

==æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸæ‰§è¡Œä¸€ä¸ªæŒ‡ä»¤==



![[Pasted image 20251005145112.png]]

==å…·æœ‰æŒ‡ä»¤çº§å¹¶è¡Œ instruction level parallelism (ILP) çš„ç¨‹åº==



![[Pasted image 20251005145050.png]]

æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸä¸­ï¼Œå¤„ç†å™¨å¯ä»¥è¯‘ç å’Œæ‰§è¡Œè‡³å¤šä¸¤ä¸ªæŒ‡ä»¤

***Superscalar executionï¼šå¤„ç†å™¨è‡ªåŠ¨æ‰¾åˆ°åœ¨æŒ‡ä»¤åºåˆ—ä¸­çš„ç‹¬ç«‹çš„æŒ‡ä»¤ï¼Œåœ¨å¤šä¸ªæ‰§è¡Œå•å…ƒä¸Šå¹¶è¡Œæ‰§è¡Œ


## 1.3 memoryå†…å­˜
![[Pasted image 20251005150049.png|400]]
![[Pasted image 20251005150356.png]]
* ==å†…å­˜æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„==
* æ¯ä¸ªå­—èŠ‚è¢«å®ƒåœ¨å†…å­˜ä¸­çš„åœ°å€å®šä¹‰
	* åœ°å€æ˜¯åœ¨è¿™ä¸ªæ•°ç»„ä¸­çš„ä½ç½®
	* ***å†…å­˜æ˜¯ byte-addressable æŒ‰å­—èŠ‚å¯»å€çš„

å³å›¾ä¸­ï¼Œè¿™ä¸ªç¨‹åºçš„å†…å­˜åœ°å€ç©ºé—´æ˜¯32 byteså¤§å°ï¼Œåˆæ³•åœ°å€æ˜¯ä»0x0åˆ°0x1F

| è‹±                | ä¸­             | è¯´æ˜                  |
| ---------------- | ------------- | ------------------- |
| byte-addressable | æŒ‰å­—èŠ‚å¯»å€ / å­—èŠ‚å¯å¯»å€ | æ¯ä¸ªå­—èŠ‚æœ‰å”¯ä¸€åœ°å€           |
| word-addressable | æŒ‰å­—å¯»å€          | æ¯ä¸ªå­—ï¼ˆé€šå¸¸ 2/4 å­—èŠ‚ï¼‰æœ‰å”¯ä¸€åœ°å€ |
| bit-addressable  | æŒ‰ä½å¯»å€          | æ¯ä¸ªä½éƒ½æœ‰å”¯ä¸€åœ°å€           |
> â€œByte-addressableâ€ æ„æ€æ˜¯ **å†…å­˜ä¸­çš„æ¯ä¸€ä¸ªå­—èŠ‚ï¼ˆ8 ä½ï¼‰éƒ½æœ‰å”¯ä¸€çš„åœ°å€**ã€‚
> ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤„ç†å™¨è®¿é—®å†…å­˜æ—¶ï¼Œ**æœ€å°çš„å¯å¯»å€å•ä½æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼ˆbyteï¼‰**ã€‚
> åœ¨ç°ä»£è®¡ç®—æœºä¸­ï¼Œä¸»å­˜é€šå¸¸æ˜¯ **byte-addressable** çš„ã€‚  
    æ¯”å¦‚ï¼Œä¸€ä¸ª 32 ä½åœ°å€æ€»çº¿å¯ä»¥è¡¨ç¤º $2^{32}$ ä¸ªå­—èŠ‚çš„åœ°å€ç©ºé—´ï¼Œå³ 4 GBã€‚


## 1.4 Cacheç¼“å­˜
![[Pasted image 20251005182546.png]]
* **cache**ï¼šä¸å½±å“ä¸€æ®µç¨‹åºè¾“å‡ºï¼Œåªå½±å“æ€§èƒ½çš„ç¡¬ä»¶å®ç°
	* æ˜¯ä¸€æ®µç‰‡ä¸Šå­˜å‚¨ï¼ŒåŒ…å«äº†memoryå†…å­˜ä¸­çš„å€¼çš„å­é›†çš„æ‹·è´
	* å¦‚æœåœ°å€å­˜å‚¨åœ¨cacheä¸­ï¼Œç›¸æ¯”äºå­˜åœ¨DRAMï¼Œå¤„ç†å™¨å¯ä»¥==æ›´å¿«åœ°åŠ è½½/å­˜å‚¨==è¿™ä¸ªåœ°å€
	* **cache** ç¼“å­˜ä»¥â€œ==ç¼“å­˜è¡Œï¼ˆcache lineï¼‰==â€ä¸ºç²’åº¦è¿›è¡Œæ“ä½œ
		* å›¾ä¸­ï¼Œcacheå«æœ‰ä¸¤ä¸ªlines
		* æ¯ä¸€ä¸ªlineæœ‰4bytesæ•°æ®

å¦‚æœæƒ³åœ¨cacheä¸­è®¿é—®0x5ï¼Œéœ€è¦è¯·æ±‚memoryï¼Œç»™æˆ‘ä»0x4å¼€å§‹çš„æ•´æ¡cache lineçš„æ‰€æœ‰ä¿¡æ¯



![[Pasted image 20251005184412.png]]
* å‡è®¾ï¼š
	- ç¼“å­˜ï¼ˆcacheï¼‰çš„æ€»å®¹é‡ä¸º **8 å­—èŠ‚**ï¼›
	- æ¯ä¸ªç¼“å­˜è¡Œï¼ˆcache lineï¼‰çš„å¤§å°ä¸º **4 å­—èŠ‚**ï¼Œå› æ­¤ç¼“å­˜ä¸­å¯ä»¥åŒæ—¶å®¹çº³ **2 ä¸ªç¼“å­˜è¡Œ**ï¼›
	- é‡‡ç”¨ **æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆLRUï¼ŒLeast Recently Usedï¼‰** çš„æ›¿æ¢ç­–ç•¥ã€‚
* ==æ•°æ®å±€éƒ¨æ€§ï¼ˆdata localityï¼‰== ä¸»è¦æœ‰ä¸¤ç§å½¢å¼ï¼š
	- **ç©ºé—´å±€éƒ¨æ€§ï¼ˆSpatial localityï¼‰**ï¼š  å½“åŠ è½½ä¸€ä¸ªç¼“å­˜è¡Œæ—¶ï¼Œç›¸å½“äº**é¢„å…ˆåŠ è½½äº†è¯¥ç¼“å­˜è¡Œä¸­å…¶ä»–åœ°å€çš„æ•°æ®**ã€‚  å› æ­¤ï¼Œåç»­è®¿é—®åŒä¸€ç¼“å­˜è¡Œä¸­ä¸åŒåœ°å€çš„æ•°æ®æ—¶ï¼Œå¾€å¾€ä¼š**å‘½ä¸­ç¼“å­˜ï¼ˆcache hitï¼‰**ã€‚
	- **æ—¶é—´å±€éƒ¨æ€§ï¼ˆTemporal localityï¼‰**ï¼š  å¯¹**åŒä¸€åœ°å€**è¿›è¡Œå¤šæ¬¡é‡å¤è®¿é—®æ—¶ï¼Œç”±äºè¯¥æ•°æ®ä»åœ¨ç¼“å­˜ä¸­ï¼Œä¹Ÿä¼šäº§ç”Ÿç¼“å­˜å‘½ä¸­ã€‚

ç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œä¼š**ç¼“å­˜æœªå‘½ä¸­ï¼ˆcache missï¼‰**ï¼Œâ€œcold missâ€ä¸ºå†·æœªå‘½ä¸­


![[Pasted image 20251005190706.png]]
==ç¼“å­˜æœªå‘½ä¸­ï¼ˆcache missï¼‰==åˆ†ä¸ºå¤šç§ç±»å‹
* ***â€œcold missâ€å†·æœªå‘½ä¸­ï¼šç¬¬ä¸€æ¬¡è®¿é—®åœ°å€
* ***â€œcapacity missâ€å®¹é‡æœªå‘½ä¸­ï¼šä»…ä»…ç”±äºcacheå®¹é‡æœ‰é™è€Œå‘ç”Ÿçš„æœªå‘½ä¸­
* ***â€œconflict missâ€å†²çªæœªå‘½ä¸­ï¼šç”±äºcacheç»„ç»‡æ–¹å¼è€Œå‘ç”Ÿçš„æœªå‘½ä¸­



![[Pasted image 20251009145332.png]]
***ç¼“å­˜å‡å°‘åœé¡¿æ—¶é—´ï¼ˆé™ä½å†…å­˜è®¿é—®å»¶è¿Ÿï¼‰
- å½“å¤„ç†å™¨==è®¿é—®ç¼“å­˜ä¸­å·²é©»ç•™çš„æ•°æ®==æ—¶ï¼Œå…¶è¿è¡Œæ•ˆç‡æ›´é«˜ï¼›
- å½“å¤„ç†å™¨==è®¿é—®æœ€è¿‘ä½¿ç”¨è¿‡çš„æ•°æ®==æ—¶ï¼Œç¼“å­˜å¯ä»¥æ˜¾è‘—é™ä½å†…å­˜è®¿é—®å»¶è¿Ÿï¼›  
    * æ­¤å¤–ï¼Œç¼“å­˜è¿˜æä¾›==é«˜å¸¦å®½çš„æ•°æ®ä¼ è¾“èƒ½åŠ›==ã€‚

> **stallsï¼ˆåœé¡¿ï¼‰**ï¼šæŒ‡ CPU åœ¨ç­‰å¾…æ•°æ®ä»ä¸»å­˜åŠ è½½æ—¶çš„ç©ºè½¬å‘¨æœŸã€‚
> **memory access latencyï¼ˆå†…å­˜è®¿é—®å»¶è¿Ÿï¼‰**ï¼šæŒ‡ä»è¯·æ±‚æ•°æ®åˆ°æ•°æ®å¯ç”¨ä¹‹é—´çš„æ—¶é—´ã€‚
> **cache çš„ä½œç”¨**ï¼š  
	é€šè¿‡å°†æœ€è¿‘è®¿é—®çš„æ•°æ®ä¿ç•™åœ¨æ›´æ¥è¿‘ CPU çš„ç¼“å­˜ä¸­ï¼Œå‡å°‘æ•°æ®å–ç”¨æ—¶é—´ï¼Œä»è€Œå‡å°‘å¤„ç†å™¨ç©ºé—²ç­‰å¾…ã€‚  
	åŒæ—¶ï¼Œç¼“å­˜çš„é«˜å¸¦å®½ä¹Ÿä½¿å¾—æ•°æ®è¯»å†™é€Ÿåº¦æ˜¾è‘—æå‡ã€‚



![[Pasted image 20251009154104.png]]

**ç°ä»£è®¡ç®—æœºä¸­â€œçº¿æ€§å†…å­˜åœ°å€ç©ºé—´æŠ½è±¡â€çš„å®ç°éå¸¸å¤æ‚**
* ä¸€æ¡çœ‹ä¼¼ç®€å•çš„æŒ‡ä»¤ï¼šâ€œå°†åœ°å€ X å¤„çš„å€¼åŠ è½½åˆ°å¯„å­˜å™¨ R0 ä¸­â€ï¼Œ  
* å®é™…ä¸Šå¯èƒ½æ¶‰åŠå¤šä¸ªç¼“å­˜å±‚æ¬¡ï¼ˆdata cachesï¼‰çš„å¤æ‚æ“ä½œåºåˆ—ï¼Œç”šè‡³è®¿é—®ä¸»å­˜ï¼ˆDRAMï¼‰ã€‚

**å¸¸è§çš„ç¼“å­˜å±‚çº§ç»“æ„ï¼š**  
***ç¬¬ä¸€çº§ç¼“å­˜ï¼ˆL1ï¼‰ã€ç¬¬äºŒçº§ç¼“å­˜ï¼ˆL2ï¼‰ã€ç¬¬ä¸‰çº§ç¼“å­˜ï¼ˆL3ï¼‰***

***è¶Šé è¿‘å¤„ç†å™¨çš„ç¼“å­˜å®¹é‡è¶Šå° â†’ å»¶è¿Ÿè¶Šä½
è¶Šè¿œç¦»å¤„ç†å™¨çš„ç¼“å­˜å®¹é‡è¶Šå¤§ â†’ å»¶è¿Ÿè¶Šé«˜


ç°ä»£ CPU çš„â€œå†…å­˜è®¿é—®â€å¹¶ä¸æ˜¯ç›´æ¥è®¿é—®ä¸»å†…å­˜ï¼ˆDRAMï¼‰ï¼Œ  
è€Œæ˜¯ä¾æ¬¡ç»è¿‡å¤šçº§ç¼“å­˜ï¼š

| å±‚çº§           | å…¸å‹å®¹é‡      | ä½ç½®         | è®¿é—®å»¶è¿Ÿ     | ç‰¹ç‚¹            |
| ------------ | --------- | ---------- | -------- | ------------- |
| **L1 Cache** | ~32 KB    | æœ€é è¿‘ CPU æ ¸å¿ƒ | ~1ns     | è¶…é«˜é€Ÿï¼Œå­˜æ”¾æœ€è¿‘ä½¿ç”¨çš„æ•°æ® |
| **L2 Cache** | ~256 KB   | ç¨è¿œ         | ~3-5ns   | æ¯” L1 å¤§ä½†ç¨æ…¢     |
| **L3 Cache** | ~10â€“30 MB | æ‰€æœ‰æ ¸å¿ƒå…±äº«     | ~10-20ns | å®¹é‡æ›´å¤§ã€å»¶è¿Ÿæ›´é«˜     |
| **DRAM**     | æ•° GB      | è¿œç¦» CPU     | ~100ns   | è®¿é—®æœ€æ…¢ä½†å®¹é‡æœ€å¤§     |
å› æ­¤ï¼Œä¸€ä¸ªç®€å•çš„â€œloadâ€æŒ‡ä»¤ï¼Œå…¶å®éœ€è¦ CPU ä» L1 â†’ L2 â†’ L3 â†’ DRAM é€çº§æŸ¥æ‰¾æ•°æ®ã€‚  
è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ **ç¼“å­˜å±‚æ¬¡ç»“æ„ï¼ˆcache hierarchyï¼‰** å¯¹æ€§èƒ½å¦‚æ­¤å…³é”®ã€‚


![[Pasted image 20251020174524.png]]



# 2. å¹¶è¡Œè®¡ç®—çš„ä¸‰ä¸ªä¸»è¦æ€æƒ³

![[Pasted image 20251020175543.png]]

ä»è½¯ä»¶å·¥ç¨‹å¸ˆçš„è§’åº¦æ¥è°ˆè°ˆè®¡ç®—æœºä½“ç³»ç»“æ„

å…³äºç°ä»£å¹¶è¡Œå¤„ç†å™¨å¦‚ä½•å®ç°é«˜ååé‡çš„å…³é”®æ¦‚å¿µ
- ä¸¤ä¸ªå…³æ³¨ç‚¹æ˜¯å¹¶è¡Œæ‰§è¡Œ(å¤šæ ¸ multi-coreã€SIMD å¹¶è¡Œæ‰§è¡Œ)
- ä¸€ç§æ–¹æ³•è§£å†³äº†å†…å­˜å»¶è¿Ÿçš„æŒ‘æˆ˜(å¤šçº¿ç¨‹ multi-threading)

äº†è§£è¿™äº›åŸºç¡€çŸ¥è¯†å°†å¯¹ä½ æœ‰æ‰€å¸®åŠ©
- ç†è§£å¹¶ä¼˜åŒ–å¹¶è¡Œç¨‹åºçš„æ€§èƒ½
- æ·±å…¥äº†è§£å“ªäº›å·¥ä½œå¯èƒ½ä»å¿«é€Ÿå¹¶è¡Œæœºå™¨ä¸­å—ç›Š


![[Pasted image 20251020175839.png]]

ä½¿ç”¨æ³°å‹’å±•å¼€å¼è®¡ç®—sin(x)
å¯¹äºæµ®ç‚¹æ•°æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼Œè¾“å…¥$x_i$ï¼Œè¾“å‡º$y_i$


![[Pasted image 20251020191639.png]]

ç¼–è¯‘åçš„æŒ‡ä»¤æµ instruction stream
(æ ‡é‡æŒ‡ä»¤ scalar instructions)


![[Pasted image 20251020192455.png]]

éå¸¸ç®€å•çš„å¤„ç†å™¨ï¼šæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸæ‰§è¡Œä¸€æ¡æŒ‡ä»¤


![[Pasted image 20251020192600.png]]

==è¶…æ ‡é‡å¤„ç†å™¨ superscalar processor==
è¿™é‡Œå±•ç¤ºçš„å¤„ç†å™¨å¯ä»¥**åœ¨æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸå†…è¯‘ç å¹¶æ‰§è¡Œä¸¤æ¡æŒ‡ä»¤**(å¦‚æœæ˜¯æŒ‡ä»¤æµä¸­å­˜åœ¨ç‹¬ç«‹æŒ‡ä»¤)

ä¹±åºæ§åˆ¶é€»è¾‘

æ³¨æ„ï¼šç¨‹åºç”»æ¡†åŒºåŸŸä¸å­˜åœ¨æŒ‡ä»¤çº§å¹¶è¡Œ instruction level parallelism (ILP) ï¼Œæ˜¯ç›¸äº’ä¾èµ–çš„


![[Pasted image 20251020193754.png]]

==å¤šæ ¸æ—¶ä»£ä¹‹å‰çš„å¤„ç†å™¨==
å¤§å¤šæ•°èŠ¯ç‰‡æ™¶ä½“ç®¡ç”¨äºæ‰§è¡Œæ“ä½œ,è¿™äº›æ“ä½œå¸®åŠ©ä½¿**å•ä¸ªæŒ‡ä»¤æµ**å¿«é€Ÿè¿è¡Œ

æ›´å¤šæ™¶ä½“ç®¡=æ›´å¤§çš„ç¼“å­˜ã€æ›´æ™ºèƒ½çš„ä¹±åºé€»è¾‘ã€æ›´æ™ºèƒ½çš„åˆ†æ”¯é¢„æµ‹å™¨ç­‰ã€‚

## 2.1 Idea1ï¼šmulti-coreï¼ˆå¤šæ ¸ï¼‰ 
![[Pasted image 20251021103235.png]]
==å¤šæ ¸æ—¶ä»£å¤„ç†å™¨ multi-core era processor==

ä¸å…¶ä½¿ç”¨æ™¶ä½“ç®¡æ¥å¢åŠ å¤„ç†å™¨é€»è¾‘çš„å¤æ‚æ€§ä»¥åŠ é€Ÿå•ä¸€æŒ‡ä»¤æµï¼ˆä¾‹å¦‚ï¼Œä¹±åºæ‰§è¡Œå’Œæ¨æµ‹æ€§æ“ä½œï¼‰
ä¸å¦‚é€šè¿‡å¢åŠ æ™¶ä½“ç®¡æ•°é‡æ¥ä¸ºå¤„ç†å™¨å¢åŠ æ›´å¤šæ ¸å¿ƒcoreã€‚


![[Pasted image 20251021103745.png]]

==ä¸¤ä¸ªæ ¸å¿ƒcore==ï¼šå¹¶è¡Œè®¡ç®—ä¸¤ä¸ªå…ƒç´ 

**æ›´ç®€å•çš„æ ¸å¿ƒ**ï¼šæ¯ä¸ªæ ¸å¿ƒåœ¨è¿è¡Œå•ä¸€æŒ‡ä»¤æµæ—¶å¯èƒ½ä¼šæ¯”æˆ‘ä»¬åŸå…ˆçš„â€œé«˜çº§â€æ ¸å¿ƒæ…¢ä¸€äº›ï¼ˆä¾‹å¦‚ï¼Œæ…¢25%ï¼‰ã€‚  
ä½†ç°åœ¨æœ‰ä¸¤ä¸ªæ ¸å¿ƒï¼š2Ã—0.75=1.52Ã—0.75=1.5ï¼ˆæœ‰åŠ é€Ÿçš„æ½œåŠ›ï¼ï¼‰


![[Pasted image 20251021104546.png]]

**ä½†æˆ‘ä»¬çš„ç¨‹åºæ²¡æœ‰è¡¨è¾¾å¹¶è¡Œæ€§**

è¿™æ®µ C ç¨‹åºå°†è¢«ç¼–è¯‘æˆä¸€ä¸ªæŒ‡ä»¤æµï¼Œå®ƒåœ¨ä¸€ä¸ªå¤„ç†å™¨æ ¸å¿ƒä¸Šä»¥ä¸€ä¸ªçº¿ç¨‹è¿è¡Œã€‚

å¦‚æœæ¯ä¸ªç®€å•çš„å¤„ç†å™¨æ ¸å¿ƒæ¯”åŸæ¥çš„å¤æ‚æ ¸å¿ƒæ…¢ 25%ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç¨‹åºç°åœ¨è¿è¡Œçš„é€Ÿåº¦æ¯”ä¹‹å‰æ…¢ 25%ã€‚


![[Pasted image 20251021104845.png]]

==ä½¿ç”¨ C++ çº¿ç¨‹è¡¨è¾¾å¹¶è¡Œæ€§==
1ï¸âƒ£ å®šä¹‰ç»“æ„ä½“å‚æ•°
```cpp
typedef struct {
    int N;
    int terms;
    float* x;
    float* y;
} my_args;
```
å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ `my_args`ï¼Œç”¨äºå°è£…çº¿ç¨‹å‡½æ•°éœ€è¦çš„å‚æ•°ï¼š
- `N`ï¼šè®¡ç®—çš„æ•°æ®é‡ï¼ˆä¾‹å¦‚æ•°ç»„é•¿åº¦ï¼‰
- `terms`ï¼šè®¡ç®—å±•å¼€çš„é¡¹æ•°
- `x`ã€`y`ï¼šè¾“å…¥è¾“å‡ºæ•°ç»„æŒ‡é’ˆ

2ï¸âƒ£ çº¿ç¨‹å‡½æ•°
```cpp
void my_thread_func(my_args* args)
{
    sinx(args->N, args->terms, args->x, args->y); // do work
}
```
å®šä¹‰çº¿ç¨‹è¦æ‰§è¡Œçš„å‡½æ•° `my_thread_func`ï¼Œå†…éƒ¨è°ƒç”¨ `sinx` å‡½æ•°è¿›è¡Œè®¡ç®—ã€‚

3ï¸âƒ£ å¹¶è¡Œå‡½æ•°
```cpp
void parallel_sinx(int N, int terms, float* x, float* y)
{
    std::thread my_thread;
    my_args args;

    args.N = N/2;
    args.terms = terms;
    args.x = x;
    args.y = y;

    my_thread = std::thread(my_thread_func, &args); // å¯åŠ¨çº¿ç¨‹
    sinx(N - args.N, terms, x + args.N, y + args.N); // ä¸»çº¿ç¨‹åšå¦ä¸€åŠ
    my_thread.join(); // ç­‰å¾…çº¿ç¨‹ç»“æŸ
}
```
å®šä¹‰ä¸€ä¸ªå¹¶è¡Œç‰ˆæœ¬çš„ `sinx`ï¼š
1. æŠŠä»»åŠ¡åˆ†æˆä¸¤åŠï¼š
    - å‰åŠéƒ¨åˆ†äº¤ç»™å­çº¿ç¨‹ï¼›
    - ååŠéƒ¨åˆ†ç”±ä¸»çº¿ç¨‹è‡ªå·±å®Œæˆã€‚
2. å¯åŠ¨ä¸€ä¸ªå­çº¿ç¨‹æ‰§è¡Œ `my_thread_func`ï¼›
3. ä¸»çº¿ç¨‹åŒæ—¶è®¡ç®—å¦ä¸€éƒ¨åˆ†ï¼›
4. æœ€åç”¨ `join()` ç­‰å¾…å­çº¿ç¨‹ç»“æŸï¼Œä¿è¯æ‰€æœ‰ç»“æœéƒ½è®¡ç®—å®Œã€‚

4ï¸âƒ£ sinx å‡½æ•°æœ¬ä½“
```cpp
void sinx(int N, int terms, float* x, float* y)
{
    for (int i=0; i<N; i++)
    {
        float value = x[i];
        float numer = x[i] * x[i] * x[i];
        int denom = 6; // 3!
        int sign = -1;

        for (int j=1; j<=terms; j++)
        {
            value += sign * numer / denom;
            numer *= x[i] * x[i];
            denom *= (2*j+2) * (2*j+3);
            sign *= -1;
        }

        y[i] = value;
    }
}
```
`sinx` å®ç°å¯¹ `x` æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ ç”¨æ³°å‹’å±•å¼€è¿‘ä¼¼è®¡ç®— sin(x)ã€‚  
å³ï¼š  $[  \sin(x) \approx x - \frac{x^3}{3!} + \frac{x^5}{5!} - \dots  ]$ 
æ¯ä¸ªå¾ªç¯è®¡ç®—ä¸€ä¸ªè¾“å…¥çš„ sin å€¼å¹¶å­˜å…¥ `y[i]`ã€‚

#ä¸ºä»€ä¹ˆè¦åˆ›å»ºçº¿ç¨‹ï¼Ÿ
åˆ›å»ºçº¿ç¨‹çš„ç›®çš„æ˜¯**å¹¶è¡Œè®¡ç®—**ã€‚
åŸå§‹çš„ `sinx()` æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ˆä¸€æ¬¡åªç®—ä¸€ä¸ªå…ƒç´ ï¼‰ã€‚  
`parallel_sinx()` æŠŠä»»åŠ¡ä¸€åˆ†ä¸ºäºŒï¼Œè®©ï¼š
- ä¸€ä¸ªçº¿ç¨‹ï¼ˆå­çº¿ç¨‹ï¼‰è®¡ç®—å‰åŠéƒ¨åˆ†ï¼›
- ä¸»çº¿ç¨‹è®¡ç®—ååŠéƒ¨åˆ†ï¼›
è¿™æ ·ä¸¤ä¸ª CPU æ ¸å¿ƒå¯ä»¥**åŒæ—¶å·¥ä½œ**ï¼Œç†è®ºä¸Šè®¡ç®—æ—¶é—´å‡åŠï¼ˆç†æƒ³æƒ…å†µä¸‹ï¼‰ã€‚

| æ¨¡å—                 | ä½œç”¨                 |
| ------------------ | ------------------ |
| `sinx()`           | ä¸²è¡Œè®¡ç®— sin(x) çš„è¿‘ä¼¼å€¼   |
| `my_thread_func()` | å°è£…çº¿ç¨‹çš„å·¥ä½œå†…å®¹ï¼ˆè°ƒç”¨ sinxï¼‰ |
| `parallel_sinx()`  | åˆ›å»ºçº¿ç¨‹å¹¶å¹¶è¡Œè®¡ç®—ä¸¤éƒ¨åˆ†æ•°æ®     |
| `my_thread.join()` | ç­‰å¾…å­çº¿ç¨‹ç»“æŸï¼Œç¡®ä¿æ‰€æœ‰ç»“æœå·²å†™å…¥  |


![[Pasted image 20251021121430.png]]

æ•°æ®å¹¶è¡Œè¡¨è¾¾å¼ï¼ˆåœ¨ Kayvon è™šæ„çš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œä½¿ç”¨ `forall` ç»“æ„ï¼‰

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œç¨‹åºå‘˜é€šè¿‡ `forall` å£°æ˜å¾ªç¯ä¸­æ¯æ¬¡ `i` çš„è¿­ä»£ä¹‹é—´**äº’ä¸ä¾èµ–**ï¼Œå› æ­¤å¯ä»¥**å¹¶è¡Œæ‰§è¡Œ**ã€‚
```
// å£°æ˜å¾ªç¯çš„å„æ¬¡è¿­ä»£æ˜¯ç›¸äº’ç‹¬ç«‹çš„
forall (int i from 0 to N)
```

æœ‰äº†è¿™ä¸ªä¿¡æ¯ï¼Œç¼–è¯‘å™¨å°±å¯ä»¥è‡ªåŠ¨ä¸ºä½ ç”Ÿæˆ**å¤šçº¿ç¨‹ä»£ç **ï¼ˆå³è‡ªåŠ¨å¹¶è¡ŒåŒ–æ‰§è¡Œï¼‰ã€‚

ä»£ç é€»è¾‘ï¼š
- å¤–å±‚å¾ªç¯ï¼š`forall (int i from 0 to N)`  
    â†’ è¡¨ç¤ºè¦å¯¹æ¯ä¸ªè¾“å…¥ `x[i]` åˆ†åˆ«è®¡ç®— `sin(x[i])`ã€‚  
    æ¯ä¸ª `i` çš„è®¡ç®—å½¼æ­¤ç‹¬ç«‹ï¼Œå› æ­¤å¯ä»¥å¹¶è¡Œã€‚
- å†…å±‚å¾ªç¯ï¼š`for (int j=1; j<=terms; j++)`  
    â†’ å¯¹å•ä¸ª `x[i]` è¿›è¡Œå¤šé¡¹å¼å±•å¼€è®¡ç®—ã€‚
- æœ€ç»ˆç»“æœï¼š`y[i] = value;`  
    â†’ æŠŠè®¡ç®—ç»“æœå­˜å…¥ `y` æ•°ç»„ã€‚


![[Pasted image 20251021122339.png]]
==å››æ ¸ï¼šå¹¶è¡Œè®¡ç®—å››ä¸ªå…ƒç´ ==

**å››ä¸ªç‹¬ç«‹çš„å¤„ç†æ ¸å¿ƒï¼ˆcoresï¼‰**ã€‚æ¯ä¸ªæ ¸å¿ƒéƒ½æœ‰ï¼š
- **å–æŒ‡/è¯‘ç ï¼ˆFetch/Decodeï¼‰**ï¼šä»å†…å­˜ä¸­å–å‡ºæŒ‡ä»¤å¹¶è§£æã€‚
- **æ‰§è¡Œå•å…ƒï¼ˆExec/ALUï¼‰**ï¼šç®—æœ¯é€»è¾‘å•å…ƒï¼Œç”¨æ¥æ‰§è¡Œè®¡ç®—ã€‚
- **æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecution Contextï¼‰**ï¼šå­˜æ”¾å¯„å­˜å™¨ã€å˜é‡ã€ä¸­é—´ç»“æœç­‰ã€‚
    
- å››ä¸ªæ ¸å¿ƒå„è‡ªç‹¬ç«‹åœ°å¤„ç†è‡ªå·±çš„è¾“å…¥æ•°æ®ï¼ˆæ¯ä¸ªå°æ–¹æ¡†ä»£è¡¨è¾“å…¥/è¾“å‡ºï¼Œç°è‰²æ¡ä»£è¡¨æ•°æ®å—ï¼‰ã€‚
- æ¯ä¸ªæ ¸å¿ƒå¯ä»¥***åŒæ—¶ï¼ˆå¹¶è¡Œï¼‰*** æ‰§è¡Œä¸€éƒ¨åˆ†ä»»åŠ¡ï¼Œå› æ­¤ä¸€æ¬¡å¯ä»¥è®¡ç®—å››ä¸ªæ•°æ®å…ƒç´ ã€‚
    
**å¤šæ ¸ CPU** çš„åŸºæœ¬æ¦‚å¿µï¼š
- æ¯ä¸ªæ ¸å¿ƒéƒ½èƒ½ç‹¬ç«‹æ‰§è¡Œä¸€æ¡æŒ‡ä»¤æµã€‚
- å½“ä»»åŠ¡å¯ä»¥è¢«åˆ†è§£ä¸ºå¤šä¸ªç‹¬ç«‹éƒ¨åˆ†æ—¶ï¼ˆä¾‹å¦‚å¤„ç†æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼‰ï¼Œå››ä¸ªæ ¸å¿ƒå°±èƒ½åŒæ—¶æ‰§è¡Œå››ä¸ªå­ä»»åŠ¡ã€‚
- ç†è®ºä¸Šï¼Œæ€§èƒ½å¯ä»¥æå‡è‡³å•æ ¸çš„ 4 å€ï¼ˆå–å†³äºä»»åŠ¡æ˜¯å¦å®Œå…¨å¯å¹¶è¡Œï¼‰ã€‚


![[Pasted image 20251021122406.png]]

==åå…­æ ¸ï¼šå¹¶è¡Œè®¡ç®—åå…­ä¸ªå…ƒç´ ==

åå…­ä¸ªæ ¸å¿ƒï¼Œåå…­æ¡åŒæ—¶æ‰§è¡Œçš„æŒ‡ä»¤æµ

![[Pasted image 20251021122427.png]]

==å¤šæ ¸ CPUï¼ˆIntel â€œComet Lakeâ€ i9-10900ï¼Œ2020ï¼‰==
- 10 ä¸ªçŸ©å½¢åŒºåŸŸï¼ˆCore 1~Core 10ï¼‰ï¼Œæ¯ä¸ªåŒºåŸŸéƒ½æ˜¯ä¸€ä¸ª **ç‹¬ç«‹çš„ CPU æ ¸å¿ƒï¼ˆcoreï¼‰**ã€‚
- æ¯ä¸ªæ ¸å¿ƒéƒ½èƒ½ç‹¬ç«‹æ‰§è¡ŒæŒ‡ä»¤ã€æ‹¥æœ‰è‡ªå·±çš„ç¼“å­˜ã€å¯„å­˜å™¨å’Œæ‰§è¡Œå•å…ƒã€‚
- è¿™æ˜¯ä¸€é¢—å…¸å‹çš„é«˜æ€§èƒ½ **é€šç”¨å¤„ç†å™¨ï¼ˆCPUï¼‰**ï¼Œç”¨äºæ‰§è¡Œå¤æ‚çš„é€»è¾‘è¿ç®—ã€ç³»ç»Ÿç®¡ç†ä»»åŠ¡ã€ä»¥åŠä¸²è¡Œè®¡ç®—ã€‚
**ç‰¹ç‚¹ï¼š**
- **æ ¸å¿ƒæ•°é‡è¾ƒå°‘**ï¼ˆ10 ä¸ªï¼‰ï¼Œä½†æ¯ä¸ªæ ¸å¿ƒæ€§èƒ½å¼ºã€‚
- **æ¯ä¸ªæ ¸å¿ƒç»“æ„å¤æ‚**ï¼Œå…·å¤‡åˆ†æ”¯é¢„æµ‹ã€ä¹±åºæ‰§è¡Œã€å¤šçº§ç¼“å­˜ã€‚
- é€‚åˆå¤„ç† **é¡ºåºé€»è¾‘ã€æ¡ä»¶åˆ¤æ–­å¤šã€å»¶è¿Ÿæ•æ„Ÿçš„ä»»åŠ¡**ï¼ˆå¦‚æ“ä½œç³»ç»Ÿè°ƒåº¦ã€åº”ç”¨ç¨‹åºä¸»çº¿ç¨‹ç­‰ï¼‰ã€‚


![[Pasted image 20251021122742.png]]

==å¤šæ ¸ GPUï¼ˆNVIDIA GeForce RTX 4090ï¼Œ2022ï¼‰==
- è¯¥ GPU æ‹¥æœ‰ **144 ä¸ªå¤„ç†å•å…ƒï¼ˆStreaming Multiprocessors, SMï¼‰**ã€‚
- æ¯ä¸ª SM å†…éƒ¨å†åŒ…å«æ•°åä¸ªå°çš„è¿ç®—æ ¸å¿ƒï¼ˆCUDA coresï¼‰ï¼Œä¸“é—¨å¤„ç†å¹¶è¡Œæ•°æ®ã€‚
**ç‰¹ç‚¹ï¼š**
- **æé«˜çš„å¹¶è¡Œåº¦**ï¼šæ•°åƒä¸ªå°è®¡ç®—å•å…ƒå¯ä»¥åŒæ—¶æ‰§è¡ŒåŒä¸€ç§è¿ç®—ã€‚
- æ¯ä¸ªæ ¸å¿ƒç›¸å¯¹ç®€å•ï¼Œä½†æ€»æ•°é‡å·¨å¤§ï¼Œä¸“ä¸º **å¹¶è¡Œè®¡ç®—** è€Œè®¾è®¡ã€‚
- é€‚åˆå¤„ç† **å›¾å½¢æ¸²æŸ“ã€AIæ¨ç†ã€ç§‘å­¦è®¡ç®—** ç­‰éœ€è¦åŒæ—¶å¤„ç†å¤§é‡ç›¸ä¼¼æ•°æ®çš„ä»»åŠ¡ã€‚
- ä¸ CPU ä¸åŒï¼ŒGPU ä¸æ“…é•¿é€»è¾‘å¤æ‚æˆ–åˆ†æ”¯å¤šçš„ä»»åŠ¡ã€‚


![[Pasted image 20251021122816.png]]

==è‹¹æœæ‰‹æœºä¸­çš„ SoCï¼ˆSystem on Chipï¼‰ï¼Œå³â€œç³»ç»Ÿçº§èŠ¯ç‰‡â€ã€‚==
- é‡‡ç”¨ **å¼‚æ„å¤šæ ¸ï¼ˆheterogeneous multi-coreï¼‰æ¶æ„**ï¼š
    - **2 ä¸ªâ€œå¤§æ ¸â€**ï¼šé«˜æ€§èƒ½æ ¸å¿ƒï¼Œç”¨äºè¿è¡Œé«˜è´Ÿè½½ä»»åŠ¡ã€‚
    - **4 ä¸ªâ€œå°æ ¸â€**ï¼šé«˜èƒ½æ•ˆæ ¸å¿ƒï¼Œç”¨äºè½»é‡ä»»åŠ¡ï¼ŒèŠ‚çœåŠŸè€—ã€‚
- åŒæ—¶é›†æˆäº† **GPUã€NPUï¼ˆç¥ç»ç½‘ç»œå¤„ç†å•å…ƒï¼‰** å’Œç¼“å­˜åŒºã€‚
**ç‰¹ç‚¹ï¼š**
- **æ€§èƒ½ä¸åŠŸè€—å…¼é¡¾**ï¼šé€šè¿‡æ™ºèƒ½è°ƒåº¦ï¼Œâ€œå¤§æ ¸â€å¤„ç†é«˜æ€§èƒ½ä»»åŠ¡ï¼Œâ€œå°æ ¸â€å¤„ç†åå°ä»»åŠ¡ã€‚
- æ˜¯ä¸€ç§ **ç§»åŠ¨è®¾å¤‡å¸¸ç”¨æ¶æ„ï¼ˆbig.LITTLE è®¾è®¡ï¼‰**ã€‚
- é€‚åˆæ‰‹æœºå’ŒåµŒå…¥å¼åœºæ™¯ï¼Œèƒ½åœ¨æœ‰é™åŠŸè€—ä¸‹ä¿æŒé«˜æ€§èƒ½ã€‚

|èŠ¯ç‰‡ç±»å‹|å…¸å‹ç”¨é€”|æ ¸å¿ƒæ•°é‡|æ ¸å¿ƒç±»å‹|ç‰¹ç‚¹|
|---|---|---|---|---|
|**CPU**|é€šç”¨è®¡ç®—ã€ç³»ç»Ÿè°ƒåº¦|å°‘ï¼ˆ4â€“16ï¼‰|å¤æ‚æ ¸å¿ƒ|é«˜çµæ´»æ€§ï¼Œä½å¹¶è¡Œåº¦|
|**GPU**|å›¾å½¢æ¸²æŸ“ã€AIè®¡ç®—|å¤šï¼ˆä¸Šåƒï¼‰|ç®€å•æ ¸å¿ƒ|æé«˜å¹¶è¡Œåº¦ï¼Œä½æ§åˆ¶èƒ½åŠ›|
|**SoC (A15)**|ç§»åŠ¨è®¾å¤‡ã€æ··åˆä»»åŠ¡|ä¸­ç­‰ï¼ˆ6 CPUæ ¸ + GPU + NPUï¼‰|å¼‚æ„æ ¸å¿ƒ|æ€§èƒ½ä¸èƒ½æ•ˆå¹³è¡¡|

## 2.1 Idea2ï¼šSIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰ 
![[Pasted image 20251023112323.png]]

> **æ•°æ®å¹¶è¡Œ**ï¼š
> - æ¯æ¬¡å¾ªç¯ï¼ˆè¿­ä»£ï¼‰æ‰§è¡Œç›¸åŒçš„è®¡ç®—é€»è¾‘ï¼›
> - ä¸åŒè¿­ä»£ä¹‹é—´çš„æ•°æ®ï¼ˆ`x[i]`ï¼‰å½¼æ­¤ç‹¬ç«‹ï¼›
> - å› æ­¤å¯ä»¥å¹¶è¡Œå¤„ç†æ¯ä¸ªå…ƒç´ ã€‚
> - **æ•°æ®å¹¶è¡Œ** = åŒæ ·çš„è®¡ç®—è¿‡ç¨‹ + ä¸åŒçš„æ•°æ®è¾“å…¥ + å¯åŒæ—¶æ‰§è¡Œã€‚

**GPU å¹¶è¡Œè®¡ç®—** æˆ– **SIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰** çš„æ ¸å¿ƒæ€æƒ³ï¼š
***ä¸€æ¡ç¨‹åºæ§åˆ¶æµï¼ˆåŒæ ·çš„ä»£ç ï¼‰åŒæ—¶å¤„ç†å¤šä¸ªä¸åŒçš„æ•°æ®è¾“å…¥ã€‚


### 1ã€å¢åŠ æ‰§è¡Œå•å…ƒï¼ˆALUsï¼‰
![[Pasted image 20251023112341.png]]

> é€šè¿‡å¢åŠ æ‰§è¡Œå•å…ƒï¼ˆALUsï¼‰æå‡è®¡ç®—èƒ½åŠ› 
> 
> **ä¸»è¦æ€æƒ³ï¼ˆIdea # 2ï¼‰ï¼š**  
> å°†æŒ‡ä»¤æµçš„ç®¡ç†æˆæœ¬/å¤æ‚åº¦åˆ†æ‘Šåˆ°å¤šä¸ª ALU ä¸Šã€‚  â¡ï¸é™¤äº†ALUå…¶ä»–éƒ¨åˆ†æ‰§è¡Œä¸€æ¬¡ï¼Œå¢åŠ  ALUs ç›¸æ¯”äº multi cores èŠ‚çœæˆæœ¬
> è¿™æ„å‘³ç€å¤šä¸ª ALU å…±äº«åŒä¸€æ¡æŒ‡ä»¤æµï¼Œä»è€ŒèŠ‚çœæ§åˆ¶å¼€é”€ã€‚

> ***SIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰å¤„ç†ï¼š**
> - ä¸€æ¡æŒ‡ä»¤ï¼ˆSingle Instructionï¼‰
> - åŒæ—¶å¤„ç†å¤šç»„æ•°æ®ï¼ˆMultiple Dataï¼‰
> - ç›¸åŒçš„æŒ‡ä»¤è¢«å¹¿æ’­åˆ°æ‰€æœ‰ ALU
> - æ¯ä¸ª ALU åœ¨ä¸åŒæ•°æ®ä¸Š**å¹¶è¡Œæ‰§è¡Œç›¸åŒæ“ä½œ**

CPU å†…éƒ¨çš„ç®€åŒ–ç»“æ„ï¼š
- **Fetch/Decodeï¼ˆå–æŒ‡/è¯‘ç ï¼‰**ï¼šç»Ÿä¸€è·å–å¹¶è§£ææŒ‡ä»¤ã€‚
- **ALUï¼ˆArithmetic Logic Unitï¼‰**ï¼šç®—æœ¯é€»è¾‘å•å…ƒï¼Œæ˜¯æ‰§è¡Œå®é™…è¿ç®—çš„æ ¸å¿ƒã€‚
- **Execution Context**ï¼šæ§åˆ¶å’Œå¯„å­˜å™¨çŠ¶æ€ï¼Œç”¨äºåè°ƒ ALU çš„å¹¶è¡Œæ‰§è¡Œã€‚

CPU é€šè¿‡æ·»åŠ å¤šä¸ª ALUï¼Œåœ¨åŒä¸€æ—¶é—´æ‰§è¡ŒåŒä¸€æŒ‡ä»¤çš„å¤šä¸ªæ•°æ®ç‰ˆæœ¬ã€‚  
ä¾‹å¦‚ï¼š8 ä¸ª ALU åŒæ—¶å¯¹ 8 ä¸ªæ•°æ‰§è¡ŒåŠ æ³•æˆ–ä¹˜æ³•ã€‚


![[Pasted image 20251023112403.png]]

> åŸå§‹ç¼–è¯‘å™¨ç”Ÿæˆçš„ç¨‹åºæ˜¯**æ ‡é‡ç¨‹åº**ï¼Œ  
> æ¯æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªæ•°ç»„å…ƒç´ ã€‚  
> ä½¿ç”¨æ ‡é‡å¯„å­˜å™¨ï¼ˆå¦‚ 32 ä½æµ®ç‚¹å¯„å­˜å™¨ï¼‰æ‰§è¡Œè¿ç®—ã€‚

å³ï¼š
- æ¯æ¬¡å¾ªç¯å¤„ç†ä¸€ä¸ª `x[i]`ï¼›
- åŠ è½½æ•°æ® â†’ è¿ç®— â†’ å­˜å›ï¼›
- æ— å¹¶è¡ŒåŒ–ã€‚


### 2ã€SIMDï¼ˆAVX æŒ‡ä»¤ï¼‰å‘é‡åŒ–
![[Pasted image 20251023112422.png]]

>AVX æä¾›äº†ç‰¹æ®Šçš„æ•°æ®ç±»å‹ä¸å‡½æ•°ï¼Œ  
  å…è®¸ C ç¨‹åºå‘˜æ“ä½œ**å‘é‡æ•°æ®ï¼ˆvector datatypesï¼‰**ã€‚
  è¿™äº›å‡½æ•°å¯åœ¨ä¸€æ¡æŒ‡ä»¤ä¸­å¤„ç†**8 ä¸ª 32 ä½æµ®ç‚¹æ•°**ï¼ˆ256 ä½å¯„å­˜å™¨ï¼‰ã€‚

```
#include <immintrin.h>

void sinx(int N, int terms, float* x, float* y) {
    float three_fact = 6; // 3!
    for (int i = 0; i < N; i += 8) {  // ä¸€æ¬¡å¤„ç† 8 ä¸ªå…ƒç´ 
        __m256 origx = _mm256_load_ps(&x[i]);   // åŠ è½½8ä¸ªfloat
        __m256 numer = _mm256_mul_ps(origx, _mm256_mul_ps(origx, origx)); // x^3
        __m256 denom = _mm256_broadcast_ss(&three_fact);
        int sign = -1;

        for (int j = 1; j <= terms; j++) {
            __m256 tmp = _mm256_div_ps(_mm256_mul_ps(_mm256_set1_ps(sign), numer), denom);
            value = _mm256_add_ps(value, tmp);

            numer = _mm256_mul_ps(numer, _mm256_mul_ps(origx, origx));
            denom = _mm256_mul_ps(denom, _mm256_broadcast_ss((2*j+2)*(2*j+3)));
            sign *= -1;
        }

        _mm256_store_ps(&y[i], value); // å­˜å‚¨8ä¸ªç»“æœ
    }
}
```


![[Pasted image 20251023120238.png]]

æ‰§è¡Œæµç¨‹ï¼š
- **è¾“å…¥ï¼š** `x[i : i+8]` â€” ä¸€æ¬¡å–å‡º8ä¸ªè¿ç»­å…ƒç´ 
- **å¯„å­˜å™¨ï¼š** ä½¿ç”¨ 256 ä½å‘é‡å¯„å­˜å™¨ï¼ˆ`ymm`ï¼‰
- **æ‰§è¡Œï¼š** ä¸€æ¡æŒ‡ä»¤åŒæ—¶åœ¨è¿™ 8 ä¸ªæ•°ä¸Šæ‰§è¡ŒåŠ ã€ä¹˜ã€é™¤ç­‰æ“ä½œ
- **è¾“å‡ºï¼š** `y[i : i+8]` â€” ä¸€æ¬¡å­˜å…¥8ä¸ªç»“æœ

åœ¨ä¸€æ¡å‘é‡æŒ‡ä»¤ä¸­å¤„ç†**8 ä¸ª 32 ä½æµ®ç‚¹æ•°**ï¼ˆ256 ä½å‘é‡å¯„å­˜å™¨ï¼‰ã€‚

ğŸ’¡æ ‡é‡&å‘é‡ç¨‹åºï¼š

| ç±»å‹                  | æ‰§è¡Œæ–¹å¼       | æ¯æ¬¡æ“ä½œçš„æ•°æ®é‡   | ç¤ºä¾‹              |
| ------------------- | ---------- | ---------- | --------------- |
| **æ ‡é‡ç¨‹åº (Scalar)**   | ä¸€æ¬¡å¤„ç†ä¸€ä¸ªå…ƒç´    | 1 Ã— 32-bit | ä¼ ç»Ÿ CPU å¾ªç¯       |
| **å‘é‡ç¨‹åº (SIMD/AVX)** | ä¸€æ¬¡å¤„ç† 8 ä¸ªå…ƒç´  | 8 Ã— 32-bit | 256-bit AVX å¯„å­˜å™¨ |
ğŸ’¡æ€»ç»“ï¼š

>**æ ‡é‡ç¨‹åº**ï¼šä¸€æ¬¡è®¡ç®—ä¸€ä¸ªå…ƒç´ ã€‚  
>**å‘é‡ç¨‹åº (SIMD)**ï¼šä¸€æ¬¡è®¡ç®—å¤šä¸ªå…ƒç´ ã€‚
>é€šè¿‡ **å¢åŠ  ALU æ•°é‡ + å¹¿æ’­åŒä¸€æ¡æŒ‡ä»¤**ï¼ŒCPU å®ç°äº†é«˜æ•ˆçš„**æ•°æ®å¹¶è¡Œè®¡ç®—**ï¼Œè¿™æ­£æ˜¯ç°ä»£å‘é‡åŒ–ç¼–ç¨‹ï¼ˆå¦‚ AVXã€NEONã€CUDAï¼‰çš„åŸºç¡€ã€‚


### 3ã€å¤šæ ¸ multi cores + SIMD å¹¶è¡Œ
![[Pasted image 20251023122825.png]]
>16ä¸ª SIMD æ ¸å¿ƒï¼š128 ä¸ªå…ƒç´ å¹¶è¡Œæ‰§è¡Œ
>
>16 ä¸ªæ ¸å¿ƒï¼Œ128 ä¸ª ALUï¼ˆç®—æœ¯é€»è¾‘å•å…ƒï¼‰ï¼Œ  
>16 æ¡åŒæ—¶æ‰§è¡Œçš„æŒ‡ä»¤æµï¼ˆinstruction streamsï¼‰ï¼ˆçº¿ç¨‹ï¼‰

- 16ä¸ªæ ¸å¿ƒï¼ˆcoreï¼‰ã€‚â¡ï¸ å¤šä¸ªæ ¸å¿ƒä¹‹é—´åŒæ—¶æ‰§è¡Œä¸åŒä»»åŠ¡ï¼ˆå¤šçº¿ç¨‹æˆ–å¤šæŒ‡ä»¤æµï¼‰ï¼ˆ16ä¸ªçº¿ç¨‹ï¼‰ã€‚
- æ¯ä¸ªæ ¸å¿ƒå†…éƒ¨æœ‰8ä¸ª ALUï¼ˆSIMD å•å…ƒï¼‰ã€‚â¡ï¸ æ¯ä¸ªæ ¸å¿ƒå†…éƒ¨çš„ SIMD å•å…ƒåœ¨ä¸€æ¡æŒ‡ä»¤ä¸‹å¤„ç†å¤šç»„æ•°æ®ï¼ˆ8-wide vectors 8å®½å‘é‡ï¼‰ã€‚
- å› æ­¤ç³»ç»Ÿå¯ä»¥åŒæ—¶æ‰§è¡Œ **16 Ã— 8 = 128 ä¸ªæ•°æ®æ“ä½œ**ã€‚â¡ï¸åœ¨16æ ¸èŠ¯ç‰‡ä¸Šé€Ÿåº¦å¿«äº†128å€ï¼ˆä¸æœ€åˆçš„1core 1ALUç›¸æ¯”ï¼‰

å³â€œ***å¤šæ ¸ + å‘é‡åŒ–ï¼ˆSIMDï¼‰***â€å¹¶è¡Œç»“æ„ï¼š
***æ ¸ä¹‹é—´å¹¶è¡Œï¼ˆå¤šæŒ‡ä»¤æµï¼‰ + æ ¸å†…å¹¶è¡Œï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰**


![[Pasted image 20251023123005.png]]

> ç¨‹åºä½¿ç”¨ `forall` å‘Šè¯‰ç¼–è¯‘å™¨ï¼š  
> å¾ªç¯è¿­ä»£ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œ  
> å¹¶ä¸”ç›¸åŒçš„å¾ªç¯ä½“ä¼šåœ¨å¤§é‡æ•°æ®å…ƒç´ ä¸Šé‡å¤æ‰§è¡Œã€‚

> è¿™ç§æŠ½è±¡å¯ä»¥è®©ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆï¼š
> â¡ï¸**å¤šæ ¸å¹¶è¡Œä»£ç **ï¼ˆæ¯ä¸ªæ ¸æ‰§è¡Œä¸åŒçš„è¿­ä»£åŒºé—´ï¼‰
> â¡ï¸**SIMD å‘é‡æŒ‡ä»¤**ï¼ˆæ¯ä¸ªæ ¸å†…éƒ¨åˆ©ç”¨å¤š ALU åŒæ­¥æ‰§è¡Œï¼‰

è¿™æ®µä»£ç çš„é€»è¾‘ä½¿ç”¨äº†â€œforallâ€è¯­å¥æ¥æ˜¾å¼å£°æ˜å¾ªç¯æ˜¯æ•°æ®ç‹¬ç«‹çš„ï¼Œè¿™æ„å‘³ç€ç¼–è¯‘å™¨å¯ä»¥ï¼š
1. **å°†ä¸åŒçš„ i å€¼åˆ†é…ç»™ä¸åŒçš„æ ¸å¿ƒï¼ˆCoreï¼‰** â†’ å¤šæ ¸å¹¶è¡Œï¼›
2. **åœ¨å•ä¸ªæ ¸å¿ƒä¸­è¿›ä¸€æ­¥ç”¨ SIMD æŒ‡ä»¤å¹¶è¡Œå¤„ç†å¤šä¸ª i å€¼** â†’ æ ¸å†…å‘é‡åŒ–ï¼›
3. æœ€ç»ˆå®ç°**å¤šå±‚æ¬¡å¹¶è¡Œï¼ˆhierarchical parallelismï¼‰**ã€‚

ğŸ’¡**ä»å•æ ¸åˆ°å¤šæ ¸ + SIMDï¼š**

|çº§åˆ«|å¹¶è¡Œç±»å‹|å¹¶è¡Œå•ä½|ç¤ºä¾‹|
|---|---|---|---|
|**å•æ ¸æ ‡é‡**|æ— å¹¶è¡Œ|æ¯æ¬¡æ‰§è¡Œ 1 ä¸ªæ•°æ®|åŸå§‹ `for` å¾ªç¯|
|**SIMD æ ¸å†…å¹¶è¡Œ**|æ•°æ®å¹¶è¡Œï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰|æ¯æ¬¡æ‰§è¡Œ 8 ä¸ªæ•°æ®|ä½¿ç”¨ AVX å‘é‡æŒ‡ä»¤|
|**å¤šæ ¸å¹¶è¡Œ**|ä»»åŠ¡å¹¶è¡Œï¼ˆå¤šçº¿ç¨‹ï¼‰|æ¯ä¸ªæ ¸å¿ƒå¤„ç†ä¸€æ®µæ•°æ®|OpenMP / å¤šçº¿ç¨‹|
|**å¤šæ ¸ + SIMD**|æ··åˆå¹¶è¡Œ|16 æ ¸ Ã— 8 å…ƒç´  = 128 å…ƒç´ å¹¶è¡Œ|GPU / HPC èŠ¯ç‰‡æ¶æ„|

### 4ã€æ¡ä»¶æ‰§è¡Œï¼ˆConditional Executionï¼‰
![[Pasted image 20251023123028.png]]
![[Pasted image 20251023123041.png]]
SIMD å¤„ç†å™¨ä¸€æ¬¡èƒ½å¹¶è¡Œæ‰§è¡Œå¤šä¸ªç›¸åŒçš„æ“ä½œï¼ˆå›¾ä¸­ 8 ä¸ª ALUï¼šALU1 ~ ALU8ï¼‰ã€‚  
ä½†å½“å‡ºç°æ¡ä»¶è¯­å¥æ—¶ï¼Œä¾‹å¦‚ `if (t > 0)`ï¼Œæ¯ä¸ª ALU çš„è¾“å…¥æ•°æ®ä¸åŒï¼Œå¯èƒ½å¯¼è‡´æœ‰çš„æ‰§è¡Œ if åˆ†æ”¯ã€æœ‰çš„æ‰§è¡Œ else åˆ†æ”¯ã€‚
- åœ¨ç¬¬ä¸€ä¸ªå›¾ä¸­ï¼šæ‰€æœ‰çº¿ç¨‹æ‰§è¡Œç›¸åŒçš„ä»£ç ï¼ˆæ•ˆç‡é«˜ï¼‰ã€‚
- åœ¨ç¬¬äºŒä¸ªå›¾ä¸­ï¼šæœ‰çš„çº¿ç¨‹æ¡ä»¶ä¸ºçœŸï¼ˆTï¼‰ï¼Œæœ‰çš„ä¸ºå‡ï¼ˆFï¼‰ï¼Œå°±å¯¼è‡´åˆ†æ­§ï¼ˆdivergenceï¼‰ã€‚
è¿™ç§æƒ…å†µç§°ä¸º ***â€œbranch divergenceï¼ˆåˆ†æ”¯å‘æ•£ï¼‰â€**ã€‚


![[Pasted image 20251023123058.png]]
> æ©ç›–æˆ–ä¸¢å¼ƒéƒ¨åˆ† ALU çš„è¾“å‡º
![[Pasted image 20251023123116.png]]
> åˆ†æ”¯ç»“æŸåæ¢å¤æ»¡é€Ÿæ‰§è¡Œ

- å½“åˆ†æ”¯å­˜åœ¨æ—¶ï¼ŒSIMD å¹¶è¡Œå¤„ç†å™¨ä¼šä¸ºæ¯ä¸ªå…ƒç´ å»ºç«‹ä¸€ä¸ªâ€œæ©ç ï¼ˆmaskï¼‰â€æ¥æŒ‡ç¤ºå“ªäº› ALU å‚ä¸è®¡ç®—ã€‚
- ä¾‹å¦‚ï¼šåªæœ‰éƒ¨åˆ† ALU æ‰§è¡Œ if å—ä¸­çš„ä»£ç ï¼Œå…¶ä»–çš„è¢«â€œé—²ç½®â€ï¼ˆæ ‡çº¢å‰ï¼‰ã€‚
- å¦‚æœ `if` å’Œ `else` å—éƒ½å¾ˆè€—æ—¶ï¼Œå¤„ç†å™¨éœ€è¦**å…ˆæ‰§è¡Œ if åˆ†æ”¯ï¼Œå†æ‰§è¡Œ else åˆ†æ”¯**ï¼Œå³æ¯ä¸ªåˆ†æ”¯éƒ½æ‰§è¡Œä¸¤æ¬¡ï¼Œåªæ˜¯å±è”½æ‰ä¸€åŠçš„ç»“æœã€‚

ç»“æœï¼š
- åœ¨æœ€åæƒ…å†µä¸‹ï¼Œ**åªæœ‰ 1/8 çš„ ALU åœ¨å¹²æ´»ï¼ˆå…¶ä½™ç©ºé—²ï¼‰**ã€‚
- æ‰§è¡Œå®Œåˆ†æ”¯åï¼Œæ‰æ¢å¤å…¨éƒ¨ ALU çš„å·¥ä½œã€‚
è¿™å°±æ˜¯ SIMD æ¶æ„ä¸‹æ¡ä»¶è¯­å¥å¯¼è‡´æ€§èƒ½æŸå¤±çš„åŸå› ã€‚


![[Pasted image 20251023123140.png]]
> è®©èŠ¯ç‰‡run at 1/8 çš„æ€§èƒ½ï¼š
> - æŠŠ1/8è¿­ä»£é€åˆ°ifï¼Œéœ€è¦åäº¿æ¡æŒ‡ä»¤ï¼Œexpensive
> - 7/8æ¬¡è¿­ä»£é€åˆ°elseï¼Œcheap path

> å…¶ä»–ç†è§£ï¼š
> - ifï¼ˆi % 8 == 0ï¼‰{æ¯å…«æ¡æ•°æ®æ‰§è¡Œä¸€æ¬¡if}
> - else ç•™ç©º


### 5ã€ğŸ§©å¸¸è§æœ¯è¯­
![[Pasted image 20251023144125.png]]

> ğŸŸ¦ ***æŒ‡ä»¤æµä¸€è‡´æ€§ï¼ˆInstruction Stream Coherence / Coherent Executionï¼‰
- æŒ‡çš„æ˜¯ï¼š**åŒä¸€æ®µæŒ‡ä»¤åºåˆ—è¢«åº”ç”¨åˆ°å¤šä¸ªæ•°æ®å…ƒç´ ä¸Š**ã€‚  
    æ¢å¥è¯è¯´ï¼Œä¸åŒæ•°æ®æ‰§è¡Œçš„æ“ä½œæ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ“ä½œçš„æ•°ä¸åŒã€‚
- *Coherent Execution æ˜¯ SIMD é«˜æ•ˆæ‰§è¡Œçš„å¿…è¦æ¡ä»¶ã€‚
	å› ä¸º SIMD éœ€è¦æ‰€æœ‰é€šé“ï¼ˆALUsï¼‰æ‰§è¡Œç›¸åŒæŒ‡ä»¤ã€‚
- *ä½†åœ¨å¤šæ ¸ï¼ˆmulti-coreï¼‰å¹¶è¡Œä¸­ï¼Œä¸éœ€è¦ä¿æŒä¸€è‡´æ€§ Coherent Executionã€‚  
    å„ä¸ªæ ¸å¿ƒå¯ä»¥æ‰§è¡Œä¸åŒæŒ‡ä»¤æµï¼ˆä¸åŒçº¿ç¨‹ï¼‰ï¼Œå› ä¸ºæ¯ä¸ªæ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„å–æŒ‡å’Œè§£ç èƒ½åŠ›ã€‚
    
> ğŸŸ¦ ***åˆ†æ­§æ‰§è¡Œï¼ˆDivergent Executionï¼‰
- æŒ‡ç¨‹åºä¸­ç¼ºä¹æŒ‡ä»¤æµä¸€è‡´æ€§ã€‚
- ä¾‹å¦‚ï¼š`if` è¯­å¥å¯¼è‡´éƒ¨åˆ†çº¿ç¨‹æ‰§è¡Œ if åˆ†æ”¯ã€éƒ¨åˆ†æ‰§è¡Œ else åˆ†æ”¯ã€‚  
    â‡’ SIMD å¹¶è¡Œåº¦é™ä½ã€‚


### 6ã€ç°ä»£ CPU ä¸Šçš„ SIMD æ‰§è¡Œ
![[Pasted image 20251023144200.png]]

> ğŸŸ¦ SIMD æŒ‡ä»¤é›†ç¤ºä¾‹
- **Intel AVX2 æŒ‡ä»¤**ï¼š256ä½æ“ä½œï¼ˆ8Ã—32ä½ æˆ– 4Ã—64ä½ï¼‰ï¼ˆ8-wide float vectorsï¼‰  
    ğŸ‘‰ ä¸€æ¬¡èƒ½å¹¶è¡Œè®¡ç®— 8 ä¸ªæµ®ç‚¹æ•°æˆ– 4 ä¸ªåŒç²¾åº¦æ•°ã€‚
- **Intel AVX512 æŒ‡ä»¤**ï¼š512ä½æ“ä½œï¼ˆ16Ã—32ä½ï¼‰
- **ARM Neon æŒ‡ä»¤**ï¼š128ä½æ“ä½œï¼ˆ4Ã—32ä½ï¼‰

 >ğŸŸ¦æŒ‡ä»¤çš„æ¥æº
- ç¼–è¯‘å™¨ç”Ÿæˆ SIMD æŒ‡ä»¤çš„ä¸‰ç§æ–¹å¼ï¼š
    1. ç¨‹åºå‘˜ç›´æ¥ä½¿ç”¨ **intrinsicsï¼ˆå†…å»ºå‡½æ•°ï¼‰**ï¼›        
    2. ä½¿ç”¨æ”¯æŒå¹¶è¡Œè¯­ä¹‰çš„è¯­è¨€ç»“æ„ï¼ˆå¦‚ `forall`ï¼‰ï¼›
    3. ç¼–è¯‘å™¨è‡ªåŠ¨è¯†åˆ«å¾ªç¯ä¸­çš„ç‹¬ç«‹æ€§ï¼Œè¿›è¡Œ **è‡ªåŠ¨å‘é‡åŒ–ï¼ˆauto-vectorizationï¼‰**ã€‚

> ğŸŸ¦ ***â€œæ˜¾å¼ SIMDâ€ï¼ˆExplicit SIMDï¼‰
- ç¼–è¯‘é˜¶æ®µå®Œæˆå¹¶è¡ŒåŒ–ï¼›
- å¯é€šè¿‡æŸ¥çœ‹ç¼–è¯‘åçš„äºŒè¿›åˆ¶ç¨‹åºæ‰¾åˆ° SIMD æŒ‡ä»¤ï¼Œå¦‚ï¼š  
    `vstoreps`, `vmulps` ç­‰ã€‚


### 7ã€ç°ä»£ GPU ä¸Šçš„ SIMD æ‰§è¡Œ
![[Pasted image 20251023144217.png]]

> ğŸŸ¦ ***â€œéšå¼ SIMDâ€ï¼ˆImplicit SIMDï¼‰
- ç¼–è¯‘å™¨ä»ç”Ÿæˆæ™®é€šçš„æ ‡é‡æŒ‡ä»¤ï¼›
- ä½†**ç¡¬ä»¶**åœ¨æ‰§è¡Œæ—¶ä¼šè®©å¤šä¸ªå®ä¾‹ï¼ˆN ä¸ªçº¿ç¨‹ï¼‰åŒæ­¥æ‰§è¡ŒåŒä¸€æ¡æŒ‡ä»¤ï¼›
- å³ï¼šGPU çš„ç¡¬ä»¶è´Ÿè´£å°†åŒä¸€æŒ‡ä»¤ä½œç”¨äºä¸åŒæ•°æ®ï¼ˆSIMD ALUsï¼‰ã€‚    

> ğŸŸ¦ GPU SIMD ç‰¹æ€§
- å¤šæ•° GPU çš„ SIMD å®½åº¦ï¼ˆSIMD widthï¼‰åœ¨ **8 åˆ° 32** ä¹‹é—´ï¼›
- å¦‚æœå‘ç”Ÿ**åˆ†æ­§æ‰§è¡Œï¼ˆdivergent executionï¼‰**ï¼Œæ€§èƒ½å¯èƒ½éª¤é™ï¼›
    ä¾‹å¦‚åœ¨ 32-lane SIMD ä¸Šï¼Œæœ€åæƒ…å†µä¸‹ä»… 1/32 çš„ ALU æœ‰æ•ˆã€‚

## 2.3 ä¸‰ç§å¹¶è¡Œæ‰§è¡Œå½¢å¼æ€»ç»“
![[Pasted image 20251023144232.png]]
**æ­£äº¤æ¦‚å¿µï¼š**

> ğŸŸ¦ ***è¶…æ ‡é‡ï¼ˆSuperscalarï¼‰**
> ***åŒä¸€ä¸ªæ ¸å¿ƒä¸­ï¼Œåˆ©ç”¨æŒ‡ä»¤çº§å¹¶è¡Œï¼ˆILPï¼‰åœ¨åŒä¸€æ¡æŒ‡ä»¤æµä¸­å®ç°å¹¶è¡Œæ‰§è¡Œå¤šæ¡ä¸åŒçš„æŒ‡ä»¤***ã€‚  
- è¿™ç§å¹¶è¡Œæ€§ç”±**ç¡¬ä»¶è‡ªåŠ¨å‘ç°å’Œè°ƒåº¦**ï¼Œç¨‹åºå‘˜æˆ–ç¼–è¯‘å™¨æ— éœ€æ˜¾å¼æ ‡æ˜ã€‚
* ğŸ‘‰ä¾‹ï¼šç°ä»£ CPUï¼ˆå¦‚ Intel Core ç³»åˆ—ï¼‰å¯ä»¥åœ¨å•ä¸ªæ—¶é’Ÿå‘¨æœŸåŒæ—¶å‘å°„å¤šæ¡ä¸åŒçš„æŒ‡ä»¤åˆ°ä¸åŒåŠŸèƒ½å•å…ƒæ‰§è¡Œï¼Œæ¯”å¦‚ä¸€æ¡åŠ æ³•ã€ä¸€æ¡ä¹˜æ³•ã€ä¸€æ¡å†…å­˜è®¿é—®ã€‚

> ğŸŸ¦ ***å•æŒ‡ä»¤å¤šæ•°æ®ï¼ˆSIMDï¼‰**
> ***åŒä¸€ä¸ªæ ¸å¿ƒä¸­ï¼Œç”±ä¸€æ¡æŒ‡ä»¤åŒæ—¶æ§åˆ¶å¤šä¸ª ALUï¼Œå¯¹å¤šä¸ªæ•°æ®æ‰§è¡Œç›¸åŒæ“ä½œ***ã€‚
- å¯¹**æ•°æ®å¹¶è¡Œä»»åŠ¡**éå¸¸é«˜æ•ˆï¼ˆå¦‚å‘é‡è¿ç®—ã€å›¾åƒå¤„ç†ã€çŸ©é˜µè®¡ç®—ç­‰ï¼‰ï¼Œå› ä¸ºæ§åˆ¶æˆæœ¬è¢«åˆ†æ‘Šåˆ°å¤šä¸ªæ•°æ®ä¸Šã€‚
- å‘é‡åŒ–æ‰§è¡Œå¯ä»¥ï¼š
    - ç”±**ç¼–è¯‘å™¨æ˜¾å¼å®Œæˆ**ï¼ˆExplicit SIMDï¼Œä¾‹å¦‚ AVXã€Neon æŒ‡ä»¤é›†ï¼‰ï¼›
    - æˆ–ç”±**ç¡¬ä»¶åœ¨è¿è¡Œæ—¶è‡ªåŠ¨å®Œæˆ**ï¼ˆImplicit SIMDï¼Œä¾‹å¦‚ GPU çš„ warp æœºåˆ¶ï¼‰ã€‚
* ğŸ‘‰ä¾‹ï¼šå½“è®¡ç®— `y[i] = x[i] * 2` æ—¶ï¼ŒSIMD å¯ä»¥åŒæ—¶å¯¹ 8 ä¸ªå…ƒç´ æ‰§è¡Œä¹˜æ³•æ“ä½œï¼Œè€Œä¸æ˜¯é€ä¸ªå¾ªç¯

> ğŸŸ¦ ***å¤šæ ¸ï¼ˆMulti-coreï¼‰**
> ***å¤šä¸ªå¤„ç†æ ¸å¿ƒï¼Œæ¯ä¸ªæ ¸å¿ƒéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„æŒ‡ä»¤æµ***ã€‚
- æä¾›**çº¿ç¨‹çº§å¹¶è¡Œæ€§ï¼ˆThread-level Parallelism, TLPï¼‰**ï¼Œå³æ¯ä¸ªæ ¸å¿ƒå¯åŒæ—¶æ‰§è¡Œä¸åŒçš„æŒ‡ä»¤æµã€‚
- ç”±**è½¯ä»¶åˆ›å»ºçº¿ç¨‹**ï¼ˆå¦‚ä½¿ç”¨çº¿ç¨‹åº“ã€OpenMPã€CUDA ç­‰ï¼‰æ¥æ˜¾å¼åœ°å‘ç¡¬ä»¶æš´éœ²å¹¶è¡Œæ€§ã€‚
* ğŸ‘‰ä¾‹ï¼š å››æ ¸ CPU å¯ä»¥åŒæ—¶è¿è¡Œå››ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œä¸åŒä»»åŠ¡æˆ–æ•°æ®ç‰‡æ®µï¼Œä»è€Œå®ç°åŠ é€Ÿã€‚

| å¯¹æ¯”ç»´åº¦  | Superscalar  | SIMD                  | Multi-core      |
| ----- | ------------ | --------------------- | --------------- |
| æŒ‡ä»¤æµæ•°é‡ | 1            | 1                     | å¤šä¸ª              |
| æ•°æ®æµæ•°é‡ | 1            | å¤šä¸ª                    | å¤šä¸ª              |
| å¹¶è¡Œç²’åº¦  | æŒ‡ä»¤çº§å¹¶è¡Œ (ILP)  | æ•°æ®çº§å¹¶è¡Œ (DLP)           | çº¿ç¨‹çº§å¹¶è¡Œ (TLP)     |
| æ§åˆ¶æ–¹å¼  | ç”±ç¡¬ä»¶è‡ªåŠ¨å‘ç°      | åŒä¸€æŒ‡ä»¤æ§åˆ¶å¤šä¸ª ALU          | è½¯ä»¶åˆ›å»ºå¤šçº¿ç¨‹         |
| ç‰¹ç‚¹    | åŒä¸€æ ¸å¿ƒæ‰§è¡Œå¤šæ¡ä¸åŒæŒ‡ä»¤ | é€‚åˆæ‰¹é‡æ•°æ®è¿ç®—              | å¤šæ ¸å¿ƒç‹¬ç«‹è¿è¡Œä¸åŒæŒ‡ä»¤æµ    |
| ç¤ºä¾‹    | CPUï¼ˆä¹±åºæ‰§è¡Œï¼‰    | AVX / NEON / GPU warp | å¤šæ ¸ CPU / GPU SM |


![[Pasted image 20251023144300.png]]

> ğŸŸ¦ **å•æ ¸è¶…æ ‡é‡å¤„ç†å™¨ ï¼ˆ1 core, superscalarï¼‰ï¼š**
> æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸå¯ä»¥ä»å•ä¸€æŒ‡ä»¤æµï¼ˆsingle instruction streamï¼‰ä¸­æ‰§è¡Œæœ€å¤šä¸¤æ¡æŒ‡ä»¤ï¼ˆå‰ææ˜¯è¿™äº›æŒ‡ä»¤ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼‰ã€‚

åŒæ—¶å–å‡ºå¹¶è§£ç å¤šæ¡ç‹¬ç«‹æŒ‡ä»¤ï¼Œå¹¶å‘é€åˆ°ä¸åŒçš„æ‰§è¡Œå•å…ƒï¼ˆå¦‚åŠ æ³•å™¨ã€ä¹˜æ³•å™¨ç­‰ï¼‰ã€‚
- æ¯æ¡æŒ‡ä»¤æ¥è‡ªåŒä¸€çº¿ç¨‹ï¼ˆå•æŒ‡ä»¤æµï¼‰ã€‚
- å¹¶è¡Œæ€§ç”±ç¡¬ä»¶è‡ªåŠ¨æ£€æµ‹ï¼ˆç§°ä¸º ILPï¼šInstruction-Level Parallelismï¼‰ã€‚


> ğŸŸ¦ **åŒæ ¸å¤„ç†å™¨ï¼ˆ2 cores, no vector, no superscalarï¼‰ï¼š**  
> æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸåœ¨æ¯ä¸ªæ ¸å¿ƒä¸Šï¼Œä»å„è‡ªçš„æŒ‡ä»¤æµä¸­æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ã€‚

å¤šæ ¸ï¼ˆmulti-coreï¼‰å¹¶è¡Œã€‚
* æ¯ä¸ªæ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„å–æŒ‡ã€è§£ç ã€æ‰§è¡Œå•å…ƒå’Œä¸Šä¸‹æ–‡ï¼ˆå³ç‹¬ç«‹çº¿ç¨‹ï¼‰ã€‚
* ä¸¤ä¸ªæ ¸å¿ƒå¯ä»¥å¹¶è¡Œæ‰§è¡Œä¸åŒç¨‹åºï¼ˆä¸åŒæŒ‡ä»¤æµï¼‰ã€‚
* å¹¶è¡Œæ€§ç”±è½¯ä»¶æˆ–æ“ä½œç³»ç»Ÿæä¾›ï¼ˆä¾‹å¦‚å¤šçº¿ç¨‹ã€ä»»åŠ¡åˆ†é…ï¼‰ã€‚


> ğŸŸ¦ **å››æ ¸ SIMD å¤„ç†å™¨ï¼ˆ4 cores, 8-wide vector, no superscalarï¼‰ï¼š**
> æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸåœ¨æ¯ä¸ªæ ¸å¿ƒä¸Šï¼Œä»å„è‡ªçš„æŒ‡ä»¤æµæ‰§è¡Œä¸€æ¡8 é€šé“å®½ï¼ˆ8-wideï¼‰SIMD æŒ‡ä»¤ã€‚

ç»“åˆäº† å¤šæ ¸ï¼ˆmulti-coreï¼‰ ä¸ SIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰ï¼š
* æ¯ä¸ªæ ¸å¿ƒå†…éƒ¨æ‰§è¡Œ SIMD æŒ‡ä»¤ï¼ˆå³ä¸€æ¬¡å¯¹ 8 ä¸ªæ•°æ®å¹¶è¡Œæ“ä½œï¼‰ï¼›
* åŒæ—¶æœ‰ 4 ä¸ªæ ¸å¿ƒå¹¶è¡Œè¿è¡Œï¼Œå½¢æˆâ€œæ ¸é—´å¹¶è¡Œ + æ ¸å†…å¹¶è¡Œâ€çš„åŒå±‚ç»“æ„ï¼›
* æ¯ä¸ªæ ¸å¿ƒç‹¬ç«‹å–æŒ‡ã€è§£ç ã€æ‰§è¡Œï¼Œä½†å…±äº«åŒæ ·çš„ç¨‹åºç»“æ„ã€‚

| ç»“æ„                            | æ ¸å¿ƒæ•°é‡ | æŒ‡ä»¤æµæ•°é‡ | æ¯å‘¨æœŸæ‰§è¡Œ                           | å¹¶è¡Œç²’åº¦                 | å¹¶è¡Œæ¥æº     |
| ----------------------------- | ---- | ----- | ------------------------------- | -------------------- | -------- |
| **Superscalarï¼ˆè¶…æ ‡é‡ï¼‰**          | 1    | 1     | æœ€å¤š 1 æ¡æŒ‡ä»¤æµä¸Šçš„ 2 æ¡ç‹¬ç«‹æŒ‡ä»¤             | æŒ‡ä»¤çº§ï¼ˆILPï¼‰             | ç¡¬ä»¶è‡ªåŠ¨å‘ç°   |
| **Dual-coreï¼ˆåŒæ ¸ï¼‰**             | 2    | 2     | æ¯æ ¸ 1 æ¡æŒ‡ä»¤æµ                       | çº¿ç¨‹çº§ï¼ˆTLPï¼‰             | è½¯ä»¶çº¿ç¨‹è°ƒåº¦   |
| **SIMD Quad-coreï¼ˆå››æ ¸ + SIMDï¼‰** | 4    | 4     | æ¯æ ¸ 1 æ¡æŒ‡ä»¤æµä¸Šçš„ 1  æ¡ 8-wide SIMD æŒ‡ä»¤ | æ•°æ®çº§ + çº¿ç¨‹çº§ï¼ˆDLP + TLPï¼‰ | ç¼–è¯‘å™¨ + è½¯ä»¶ |

![[Pasted image 20251023162249.png]]
![[Pasted image 20251023162305.png]]

**å››æ ¸ Intel i7-7700K CPUï¼ˆKaby Lakeï¼‰
4 cores, per core (3-way superscalar, 8 vector)**
- å››æ ¸å¿ƒå¤„ç†å™¨ï¼ˆ**multi-cores**ï¼‰ï¼Œæ¯ä¸ªæ ¸å¿ƒåŒ…å«3 ä¸ª 8 è·¯ SIMDï¼ˆAVX2 æŒ‡ä»¤ï¼‰è¿ç®—å•å…ƒï¼ˆALUï¼‰
- æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸæ¯ä¸ªæ ¸å¿ƒå¯ä»¥è¿è¡Œ3æ¡å¹¶è¡ŒæŒ‡ä»¤ï¼ˆ**superscalar**ï¼‰ï¼Œè¿™äº›æŒ‡ä»¤æ˜¯ vector instructions å‘é‡æŒ‡ä»¤ï¼ˆ**SIMD**ï¼‰
- ç†è®ºå³°å€¼è®¡ç®—èƒ½åŠ›ä¸ºï¼š
    4æ ¸å¿ƒÃ—8è·¯Â SIMDÃ—3å•å…ƒÃ—4.2GHz=400GFLOPs4 
	**æœ€å¤š 4Ã—8Ã—3=96æ¬¡ operations**
> _å›¾ä¸­åªæ˜¾ç¤º AVX æµ®ç‚¹è¿ç®—å•å…ƒåŠå…¶å–æŒ‡/è¯‘ç æ¨¡å—ï¼ˆAVX è¿˜å…·å¤‡é¢å¤–çš„æ•´æ•°è¿ç®—èƒ½åŠ›ï¼‰_


![[Pasted image 20251023162344.png]]

**NVIDIA V100 GPU
80 cores, per core (128 ALUs, oragnized in 32-wide SIMD instructions)**
- 80 ä¸ªâ€œSMâ€ coresï¼ˆStreaming Multiprocessorï¼Œæµå¼å¤šå¤„ç†å™¨ï¼‰ï¼ˆ**multi-cores**ï¼‰ï¼›
- æ¯ä¸ª SM åŒ…å« 128 ä¸ª SIMD æ‰§è¡Œå•å…ƒï¼ˆALUï¼‰ï¼›
- ä»¥ 1.6 GHz é¢‘ç‡è¿è¡Œï¼Œæ€»ç†è®ºæ€§èƒ½çº¦ä¸ºï¼š
    80Ã—128Ã—1.6GHz=16TFLOPs
    **æœ€å¤š 80Ã—128 æ¬¡ operations**
- åŠŸè€—çº¦ä¸º **250 ç“¦**ï¼›
- L2 ç¼“å­˜ä¸º **6 MB**ã€‚



![[Pasted image 20251023162408.png|375]]

![[Pasted image 20251023162434.png|700]]



